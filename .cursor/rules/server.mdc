---
alwaysApply: false
pathGlob: server/**
---

# Server 后端项目开发规范

## 1. 技术栈

- 语言：Go 1.21+
- Web 框架：Gin
- ORM：GORM
- 数据库：SQLite
- 认证：JWT
- 日志：Zap
- 配置：Viper (YAML)
- 服务端口：6808

## 2. 分层架构

严格遵循分层架构：Handlers → Services → Repositories → Database

### 2.1 各层职责

- **Handlers** (`internal/handlers/`): HTTP请求处理、参数验证、调用Services、统一响应格式
- **Services** (`internal/services/`): 业务逻辑实现、数据验证处理
- **Repositories** (`internal/repositories/`): 数据访问抽象（当前未使用，预留）
- **Models** (`internal/models/`): 数据模型定义
- **Utils** (`internal/utils/`): 通用工具函数
- **Middleware** (`internal/middleware/`): HTTP中间件（认证、日志、CORS、错误恢复）

### 2.2 依赖规则

- Handlers 只能依赖 Services 和 Utils
- Services 可依赖 Repositories、Models、Utils、Config
- Repositories 只能依赖 Models 和 Database
- 禁止跨层调用（如 Handlers 直接调用 Repositories）

## 3. API 设计规范

### 3.1 路由规范
- 路由统一使用 `/api/` 前缀
- 使用 RESTful 风格
- 路由组使用中间件进行认证保护

### 3.2 请求处理
- 使用 Gin 的 `ShouldBindJSON` 进行参数绑定
- 使用 `validator` 进行参数验证
- 参数验证失败返回 `utils.BadRequest()`

### 3.3 响应格式
- 必须使用 `utils.Response` 统一响应格式
- 成功响应：`utils.Success(c, data)`
- 错误响应：根据错误类型使用对应函数：
  - `utils.BadRequest(c, message)` - 400 参数错误
  - `utils.Unauthorized(c, message)` - 401 未认证
  - `utils.Forbidden(c, message)` - 403 无权限
  - `utils.NotFound(c, message)` - 404 资源不存在
  - `utils.InternalServerError(c, message)` - 500 服务器错误

## 4. 认证规范

### 4.1 JWT 认证
- 使用 JWT 进行身份认证
- Token 通过 `Authorization: Bearer <token>` 请求头传递
- 需要认证的路由使用 `middleware.AuthMiddleware()` 保护
- 认证失败返回 `utils.Unauthorized()`

### 4.2 管理员账号
- 系统使用单一管理员账号
- 管理员账号和密码在 `configs/config.yaml` 中配置
- 登录验证在 Services 层进行

## 5. 配置管理

### 5.1 配置文件
- 配置文件使用 YAML 格式，位于 `configs/config.yaml`
- 使用 Viper 进行配置管理
- 配置结构定义在 `internal/config/config.go`
- 通过 `config.GetConfig()` 获取配置

### 5.2 配置项
- 服务器配置：端口（6808）、运行模式
- 数据库配置：路径、连接池
- 管理员配置：用户名、密码
- JWT 配置：密钥、过期时间
- 日志配置：级别、输出路径

## 6. 中间件规范

### 6.1 中间件顺序
中间件注册顺序（从外到内）：
1. RecoveryMiddleware - 错误恢复
2. LoggerMiddleware - 请求日志
3. CORSMiddleware - 跨域处理
4. AuthMiddleware - 认证（仅需要认证的路由）

### 6.2 自定义中间件
- 中间件定义在 `internal/middleware/` 目录
- 中间件函数返回 `gin.HandlerFunc`
- 使用 `c.Next()` 继续处理，`c.Abort()` 终止处理

## 7. 错误处理

### 7.1 错误返回
- Services 层返回业务错误（使用 `errors.New()`）
- Handlers 层将业务错误转换为 HTTP 响应
- 使用统一的错误响应格式

### 7.2 错误日志
- 使用 Zap 进行日志记录
- 错误日志包含足够的上下文信息
- 敏感信息不要记录到日志

### 7.3 Panic 处理
- 使用 `middleware.RecoveryMiddleware()` 捕获 panic
- 不要在生产代码中使用 panic，除非是致命错误

## 8. 数据库规范

### 8.1 GORM 使用
- 使用 GORM 作为 ORM 框架
- 模型定义在 `internal/models/` 目录
- 数据库操作封装在 Repositories 层（当前未使用，预留）

### 8.2 数据库迁移
- 使用 GORM 的 `AutoMigrate` 进行自动迁移
- 迁移逻辑在 `internal/database/db.go` 中
- 数据库文件默认存储在 `./data/app.db`

## 9. 接口文档

- 接口文档位于 `docs/` 目录
- 按功能模块划分目录
- 一个接口对应一个文档文件
- 包含请求参数、响应格式、错误码说明
